---
id: 699
title: 'Utiliser Chef #3 &#8211; TDD ! 2/2'
author: Nicolas Ledez
layout: post
guid: http://blog.ledez.net/?p=699
permalink: /informatique/chef-3-tdd-2/
hide_post_title:
  - default
unlink_post_title:
  - default
hide_post_meta:
  - default
hide_post_date:
  - default
hide_post_image:
  - default
unlink_post_image:
  - default
builder_switch_frontend:
  - 0
categories:
  - DevOps
  - Informatique
tags:
  - chef
  - devops
  - TDD
---
[<img class="alignnone" alt="I love TDD" src="http://blog.ledez.net/wp-content/uploads/2013/05/ILoveTdd.png" width="260" height="269" />][1]

Dans [l&rsquo;article précédent &laquo;&nbsp;Utiliser Chef #3 – TTD ! 1/2 &laquo;&nbsp;][2], je vous ai promis d&rsquo;avoir rapidement la suite. Voilà chose faite !

Nous avons vu le principe du TDD. Dans ce qui va suivre, nous allons écrire les tests puis la recette Chef.

Et tout ça en mode TDD.

<!--more-->

Hop hop hop, maintenant utilisons tout ce que nous avons installé :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> foodcritic cookbooks<span class="sy0">/</span>nginx_unicorn<br /> FC008: Generated cookbook metadata needs updating: cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>metadata.rb:<span class="nu0">2</span><br /> FC008: Generated cookbook metadata needs updating: cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>metadata.rb:<span class="nu0">3</span>
  </div>
</div>

[Foodcritic][3] en bon critique culinaire vous remonte les problèmes grossiers que vous avez dans votre recette Chef.

Allons corriger tout ça :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> <span class="kw3">cd</span> cookbooks<span class="sy0">/</span>nginx_unicorn<br /> <span class="sy0">%</span> <span class="kw2">vi</span> metadata.rb <span class="co0"># Ou l'éditeur texte que vous voulez</span>
  </div>
</div>

Le but est de remplacer les informations par rapport à votre recette Chef :

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;">
  <div class="text codecolorer">
    name 'nginx_unicorn'<br /> maintainer 'YOUR_COMPANY_NAME'<br /> maintainer_email 'YOUR_EMAIL'<br /> license 'All rights reserved'<br /> description 'Installs/Configures nginx_unicorn'<br /> long_description IO.read(<br /> File.join(File.dirname(__FILE__), 'README.md'))<br /> version '0.1.0'
  </div>
</div>

Par :

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;">
  <div class="text codecolorer">
    name 'nginx_unicorn'<br /> maintainer 'Ledez Incorporated'<br /> maintainer_email 'yes-I-love@spam.com'<br /> license 'All rights reserved'<br /> description 'Installs/Configures nginx & unicorn'<br /> long_description IO.read(File.join(File.dirname(__FILE__), 'README.md'))<br /> version '0.1.0'
  </div>
</div>

Au passage éditez le fichier README.md

Maintenant le critique gastronomique semble content de notre repas :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> foodcritic .
  </div>
</div>

La commande ne doit rien retourner. Dans le cas contraire, vous avez un problème.

TDD ! TDD ! TDD ! :

Les commandes suivantes vont créer la coquille vide pour faire des tests unitaires avec chef-spec puis les lancer :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> knife cookbook create_specs nginx_unicorn<br /> <span class="sy0">**</span> Creating specs <span class="kw1">for</span> cookbook: nginx_unicorn<br /> <span class="sy0">%</span> bundle <span class="kw3">exec</span> rspec <span class="re5">--color</span><br /> <span class="sy0">*</span><br /> <br /> Pending:<br /> nginx_unicorn::default should <span class="kw1">do</span> something<br /> <span class="co0"># Your recipe examples go here.</span><br /> <span class="co0"># ./spec/default_spec.rb:5</span><br /> <br /> Finished <span class="kw1">in</span> <span class="nu0">0.00045</span> seconds<br /> <span class="nu0">1</span> example, <span class="nu0"></span> failures, <span class="nu0">1</span> pending
  </div>
</div>

Donc en gros un exemple qui est considéré comme &laquo;&nbsp;en cours&nbsp;&raquo;. Ça se confirme en regardant le fichier tout nouvellement générer (spec/default_spec.rb) :

<div class="codecolorer-container ruby default" style="overflow:auto;white-space:nowrap;">
  <div class="ruby codecolorer">
    <span class="kw3">require</span> <span class="st0">'chefspec'</span><br /> <br /> describe <span class="st0">'nginx_unicorn::default'</span> <span class="kw1">do</span><br /> &nbsp; let <span class="br0">&#40;</span><span class="re3">:chef_run</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re2">ChefSpec::ChefRunner</span>.<span class="me1">new</span>.<span class="me1">converge</span> <span class="st0">'nginx_unicorn::default'</span> <span class="br0">&#125;</span><br /> &nbsp; it <span class="st0">'should do something'</span> <span class="kw1">do</span><br /> &nbsp; &nbsp; pending <span class="st0">'Your recipe examples go here.'</span><br /> &nbsp; <span class="kw1">end</span><br /> <span class="kw1">end</span>
  </div>
</div>

Nous allons faire notre premier test (on remplace le bloc it&#8230;end) :

<div class="codecolorer-container ruby default" style="overflow:auto;white-space:nowrap;">
  <div class="ruby codecolorer">
    it <span class="st0">'should deploy nginx'</span> <span class="kw1">do</span><br /> &nbsp; runner = expect<span class="br0">&#40;</span>chef_run<span class="br0">&#41;</span><br /> <br /> &nbsp; runner.<span class="me1">to</span> install_package <span class="st0">"nginx"</span><br /> <span class="kw1">end</span>
  </div>
</div>

Et on lance le test :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> rspec <span class="re5">--color</span><br /> Compiling Cookbooks...<br /> F<br /> <br /> Failures:<br /> <br /> <span class="nu0">1</span><span class="br0">&#41;</span> nginx_unicorn::default should deploy nginx<br /> Failure<span class="sy0">/</span>Error: runner.to install_package <span class="st0">"nginx"</span><br /> No package resource named <span class="st_h">'nginx'</span> with action :install found.<br /> <span class="co0"># ./spec/default_spec.rb:8:in `block (2 levels) in '</span><br /> <br /> Finished <span class="kw1">in</span> <span class="nu0">0.00393</span> seconds<br /> <span class="nu0">1</span> example, <span class="nu0">1</span> failure<br /> <br /> Failed examples:<br /> <br /> rspec .<span class="sy0">/</span>spec<span class="sy0">/</span>default_spec.rb:<span class="nu0">5</span> <span class="co0"># nginx_unicorn::default should deploy nginx</span>
  </div>
</div>

C&rsquo;est rouge ! Notre test ne marche pas ! Et ben c&rsquo;est une bonne nouvelle. Nous allons maintenant modifier ce qu&rsquo;il faut dans Chef pour que ça passe vert (en éditant le fichier recipes/default.rb) :

<div class="codecolorer-container ruby default" style="overflow:auto;white-space:nowrap;">
  <div class="ruby codecolorer">
    <span class="co1">#</span><br /> <span class="co1"># Cookbook Name:: nginx_unicorn</span><br /> <span class="co1"># Recipe:: default</span><br /> <span class="co1">#</span><br /> <span class="co1"># Copyright 2013, Ledez Incorporated</span><br /> <span class="co1">#</span><br /> <span class="co1"># All rights reserved - Do Not Redistribute</span><br /> <span class="co1">#</span><br /> package <span class="st0">"nginx"</span> <span class="kw1">do</span><br /> action <span class="re3">:install</span><br /> <span class="kw1">end</span>
  </div>
</div>

Et on relance maintenant le test :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> rspec <span class="re5">--color</span><br /> Compiling Cookbooks...<br /> .<br /> <br /> Finished <span class="kw1">in</span> <span class="nu0">0.00429</span> seconds<br /> <span class="nu0">1</span> example, <span class="nu0"></span> failures
  </div>
</div>

Vous voyez ça vient vite <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" />

Vous pouvez éditer vos fichiers en parralléle, avec vim c&rsquo;est comme ça :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> <span class="kw2">vim</span> <span class="re5">-o</span> recipes<span class="sy0">/</span>default.rb spec<span class="sy0">/</span>default_spec.rb
  </div>
</div>

Sauf que relancer les tests toutes les 30s, ça va vite vous saouler. En tout cas moi oui <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" /> J&rsquo;utilise donc [guard][4] :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> guard init<br /> <span class="nu0">23</span>:<span class="nu0">25</span>:01 - INFO - Writing new Guardfile to <span class="sy0">/</span>Users<span class="sy0">/</span>nico<span class="sy0">/</span>Devs<span class="sy0">/</span>Ruby<span class="sy0">/</span>chef<span class="sy0">/</span>demo<span class="sy0">/</span>cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>Guardfile<br /> <span class="nu0">23</span>:<span class="nu0">25</span>:01 - INFO - rspec guard added to Guardfile, feel <span class="kw2">free</span> to edit it
  </div>
</div>

On vire les exemples qui ne servent à rien (Rails, Capybara et Turnip) dans le fichier Guardfile :

<div class="codecolorer-container ruby default" style="overflow:auto;white-space:nowrap;">
  <div class="ruby codecolorer">
    <span class="co1"># A sample Guardfile</span><br /> <span class="co1"># More info at https://github.com/guard/guard#readme</span><br /> <br /> guard <span class="re3">:rspec</span>, <span class="re3">:cli</span> =<span class="sy0">&</span>gt; <span class="st0">'--color --format doc'</span> <span class="kw1">do</span><br /> watch<span class="br0">&#40;</span><span class="sy0">%</span>r<span class="br0">&#123;</span>^spec<span class="sy0">/</span>.<span class="sy0">+</span>_spec\.<span class="me1">rb</span>$<span class="br0">&#125;</span><span class="br0">&#41;</span><br /> watch<span class="br0">&#40;</span><span class="sy0">%</span>r<span class="br0">&#123;</span>^recipes<span class="sy0">/</span><span class="br0">&#40;</span>.<span class="sy0">+</span><span class="br0">&#41;</span>\.<span class="me1">rb</span>$<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="sy0">|</span>m<span class="sy0">|</span> <span class="st0">"spec/#{m[1]}_spec.rb"</span> <span class="br0">&#125;</span><br /> watch<span class="br0">&#40;</span><span class="st0">'spec/spec_helper.rb'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="st0">"spec"</span> <span class="br0">&#125;</span><br /> <span class="kw1">end</span>
  </div>
</div>

Au passage, on ajoute des paramètres pour le la sortie de [rspec][5] soit en couleur. C&rsquo;est tout bête, mais un vert vert et un rouge rouge c&rsquo;est plus rapidement vu <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" /> vous avez noté aussi les changements du côté &laquo;&nbsp;lib&nbsp;&raquo; à remplacer par recipes. Car à la base rspec sert à tester du code [Ruby][6]. Vous lancez tout ça avec :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle <span class="kw3">exec</span> guard<br /> <span class="nu0">23</span>:<span class="nu0">35</span>:<span class="nu0">56</span> - INFO - Guard uses Growl to send notifications.<br /> <span class="nu0">23</span>:<span class="nu0">35</span>:<span class="nu0">56</span> - INFO - Guard uses TerminalTitle to send notifications.<br /> <span class="nu0">23</span>:<span class="nu0">35</span>:<span class="nu0">56</span> - INFO - Guard::RSpec is running<br /> <span class="nu0">23</span>:<span class="nu0">35</span>:<span class="nu0">56</span> - INFO - Guard is now watching at <span class="st_h">'/Users/nico/Devs/Ruby/chef/demo/cookbooks/nginx_unicorn'</span><br /> <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> guard<span class="br0">&#40;</span>main<span class="br0">&#41;</span><span class="sy0">&</span>gt;
  </div>
</div>

Maintenant, à chaque modification dans un fichier le test correspondant est relancé. Essayez, vous allez vite comprendre.

A partir de maintenant, continuez de même &laquo;&nbsp;Test rouge&nbsp;&raquo; -> &laquo;&nbsp;Code simple vert&nbsp;&raquo; -> &laquo;&nbsp;Refactoring&nbsp;&raquo; -> passez par la case départ sans prendre les 20000 Euros. Et pensez à faire des commit réguliers <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" />

EDIT: J&rsquo;ai oublié de mettre à jours le [repository Github][7]

 [1]: http://blog.ledez.net/wp-content/uploads/2013/05/ILoveTdd.png
 [2]: http://blog.ledez.net/divers/chef-3-ttd-1/ "Utiliser Chef #3 – TTD ! 1/2"
 [3]: http://acrmp.github.io/foodcritic/ "A lint tool for your Chef cookbooks"
 [4]: http://rubydoc.info/gems/guard/frames "Le site de Guard"
 [5]: http://rspec.info/ "Le site de rspec"
 [6]: http://www.ruby-lang.org/fr/ "Le site de référence de Ruby"
 [7]: https://github.com/nledez/chef-demo-repo/tree/article03 "Entrepôt à jour par rapport à l'article 3"
