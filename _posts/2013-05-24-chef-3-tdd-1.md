---
id: 673
title: 'Utiliser Chef #3 &#8211; TDD ! 1/2'
author: Nicolas Ledez
layout:
  - default
guid: http://blog.ledez.net/?p=673
permalink: /divers/chef-3-tdd-1/
hide_post_title:
  - default
unlink_post_title:
  - default
hide_post_meta:
  - default
hide_post_date:
  - default
hide_post_image:
  - default
unlink_post_image:
  - default
builder_switch_frontend:
  - 0
feature_size:
  - blank
categories:
  - Divers
---
Bon, les choses sérieuses vont commencer ! Je vous sens frétiller avec Chef installé sur votre machine <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" />

<3615MaVie>  
Je pensais le publier beaucoup plus tôt, mais je suis super pris au boulot en ce moment et le soir je suis lessivé. L&rsquo;article étant trop long, je vais le publier en 2 parties. Une aujourd&rsquo;hui et une autre début de semaine prochaine.  
</3615MaVie>

Pour poser les bases, je suis un gros fan de TDD ([Test Driven Development][1]) et BDD ([Behavior Driven Development][2]).

<!--more-->

Ce qu&rsquo;il faut retenir, c&rsquo;est les étapes :

<div id="attachment_675" style="width: 639px" class="wp-caption alignnone">
  <a href="http://blog.ledez.net/wp-content/uploads/2013/05/Red-Green-Refactor-4.png"><img class="size-full wp-image-675" src="http://blog.ledez.net/wp-content/uploads/2013/05/Red-Green-Refactor-4.png" alt="Schéma TDD" width="629" height="341" /></a>
  
  <p class="wp-caption-text">
    Schéma TDD
  </p>
</div>

Étape 1, écrire le test qui forcement est rouge.

Étape 2, écrire le code le plus simple pour passer le test au vert.

Étape 3, regarder si l&rsquo;on ne peut pas &laquo;&nbsp;refactorer&nbsp;&raquo; tout ça en gardant les tests verts.

Avec les priorités :

&#8211; BDD -> le &laquo;&nbsp;fonctionnel&nbsp;&raquo;

&#8211; TDD -> les tests unitaires/intégration

Vous l&rsquo;avez compris, il faut donc commencer par écrire le mode de fonctionnement voulu du cookbook. Sauf que je sais que là, vous êtes sur les dents. Et que vous avez envie de jouer concrètement avec Chef.

Je vais donc vous montrer maintenant comment faire des tests bas niveau avec Chef.

Première étape, récupérez de quoi avoir un repository &laquo;&nbsp;perso&nbsp;&raquo; :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> <span class="kw3">cd</span> <span class="sy0">/</span>mon<span class="sy0">/</span>repertoire<span class="sy0">/</span>de<span class="sy0">/</span>larticle<span class="sy0">/</span>precedent<br /> <span class="sy0">%</span> <span class="kw2">ls</span><br /> Gemfile Gemfile.lock README.md<br /> <span class="sy0">%</span> <span class="kw2">git clone</span> https:<span class="sy0">//</span>github.com<span class="sy0">/</span>opscode<span class="sy0">/</span>chef-repo.git<br /> Cloning into <span class="st_h">'chef-repo'</span>...<br /> remote: Counting objects: <span class="nu0">209</span>, done.<br /> remote: Compressing objects: <span class="nu0">100</span><span class="sy0">%</span> <span class="br0">&#40;</span><span class="nu0">126</span><span class="sy0">/</span><span class="nu0">126</span><span class="br0">&#41;</span>, done.<br /> remote: Total <span class="nu0">209</span> <span class="br0">&#40;</span>delta <span class="nu0">75</span><span class="br0">&#41;</span>, reused <span class="nu0">170</span> <span class="br0">&#40;</span>delta <span class="nu0">49</span><span class="br0">&#41;</span><br /> Receiving objects: <span class="nu0">100</span><span class="sy0">%</span> <span class="br0">&#40;</span><span class="nu0">209</span><span class="sy0">/</span><span class="nu0">209</span><span class="br0">&#41;</span>, <span class="nu0">35.05</span> KiB, done.<br /> Resolving deltas: <span class="nu0">100</span><span class="sy0">%</span> <span class="br0">&#40;</span><span class="nu0">75</span><span class="sy0">/</span><span class="nu0">75</span><span class="br0">&#41;</span>, done.<br /> <span class="sy0">%</span> <span class="kw3">cd</span> chef-repo<br /> <span class="sy0">%</span> <span class="kw2">ls</span><br /> LICENSE Rakefile chefignore cookbooks environments<br /> README.md certificates config data_bags roles<br /> <span class="sy0">%</span> <span class="kw2">rm</span> <span class="re5">-rf</span> .git<br /> <span class="sy0">%</span> <span class="kw2">mv</span> README.md ..<span class="sy0">/</span>README-chef.md <span class="co0"># Si vous voulez garder votre README.md d'origine</span><br /> <span class="sy0">%</span> <span class="kw2">mv</span> <span class="sy0">*</span> ..<br /> <span class="kw2">mv</span> .gitignore ..<br /> <span class="sy0">%</span> <span class="kw3">cd</span> ..<br /> <span class="sy0">%</span> <span class="kw2">git add</span> .gitignore <span class="sy0">*</span><br /> <span class="sy0">%</span> <span class="kw2">git commit</span> <span class="re5">-m</span> <span class="st0">"Add a clean chef repo"</span><br /> <span class="br0">&#91;</span>master 2e7e758<span class="br0">&#93;</span> Add a clean chef repo<br /> <span class="nu0">11</span> files changed, <span class="nu0">545</span> insertions<span class="br0">&#40;</span>+<span class="br0">&#41;</span>, <span class="nu0">1</span> deletion<span class="br0">&#40;</span>-<span class="br0">&#41;</span><br /> create mode <span class="nu0">100644</span> LICENSE<br /> create mode <span class="nu0">100644</span> README-chef.md<br /> create mode <span class="nu0">100644</span> Rakefile<br /> create mode <span class="nu0">100644</span> certificates<span class="sy0">/</span>README.md<br /> create mode <span class="nu0">100644</span> chefignore<br /> create mode <span class="nu0">100644</span> config<span class="sy0">/</span>rake.rb<br /> create mode <span class="nu0">100644</span> cookbooks<span class="sy0">/</span>README.md<br /> create mode <span class="nu0">100644</span> data_bags<span class="sy0">/</span>README.md<br /> create mode <span class="nu0">100644</span> environments<span class="sy0">/</span>README.md<br /> create mode <span class="nu0">100644</span> roles<span class="sy0">/</span>README.md
  </div>
</div>

Vous avez maintenant de quoi faire des cookbooks pour votre environnement cible de Chef.

Je vais prendre un exemple qui va consister à mettre en place avec un Raspberry π pour en faire un serveur Web afin d’héberger des applications Ruby.

GO !

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> knife cookbook create nginx_unicorn<br /> <span class="sy0">%</span> <span class="kw2">git status</span><br /> <span class="co0"># On branch master</span><br /> <span class="co0"># Untracked files:</span><br /> <span class="co0"># cookbooks/nginx_unicorn/</span><br /> <span class="sy0">%</span> <span class="kw2">git add</span> cookbooks<span class="sy0">/</span>nginx_unicorn ; <span class="kw2">git commit</span> <span class="re5">-m</span> <span class="st0">"Fresh nginx_unicorn cookbook"</span><br /> <span class="br0">&#91;</span>master 5be0d84<span class="br0">&#93;</span> Fresh nginx_unicorn cookbook<br /> <span class="nu0">4</span> files changed, <span class="nu0">95</span> insertions<span class="br0">&#40;</span>+<span class="br0">&#41;</span><br /> create mode <span class="nu0">100644</span> cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>CHANGELOG.md<br /> create mode <span class="nu0">100644</span> cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>README.md<br /> create mode <span class="nu0">100644</span> cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>metadata.rb<br /> create mode <span class="nu0">100644</span> cookbooks<span class="sy0">/</span>nginx_unicorn<span class="sy0">/</span>recipes<span class="sy0">/</span>default.rb
  </div>
</div>

Et voilà, vous avez fait votre premier cookbook <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" />

Pour aller un peu plus loin, nous allons avoir besoin de plusieurs Gem supplémentaires. Dans le [dernier article][3], nous avons utilisé :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> gem <span class="kw2">install</span> chef
  </div>
</div>

Pour simplifier la compatibilité des Gems (mais aussi pour votre bien) utilisé dans l&rsquo;article avec ce que vous pourrez utiliser chez vous. Je vais installer [Bundler][4] qui en 3 mots est un gestionnaire de Gem Ruby. Laissez vous faire, ça va marcher tout seul <img src="https://blog.ledez.net/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" />

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> gem <span class="kw2">install</span> bundler <span class="re5">--no-ri</span> <span class="re5">--no-rdoc</span><br /> Successfully installed bundler-1.3.5<br /> <span class="nu0">1</span> gem installed
  </div>
</div>

Jusqu&rsquo;a présent, j&rsquo;avais dans mon Gemfile ceci :

<div class="codecolorer-container ruby default" style="overflow:auto;white-space:nowrap;">
  <div class="ruby codecolorer">
    source <span class="st0">"https://rubygems.org"</span>
  </div>
</div>

gem &laquo;&nbsp;chef&nbsp;&raquo;

Pour mettre à jour :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="sy0">%</span> bundle<br /> Using erubis <span class="br0">&#40;</span>2.7.0<span class="br0">&#41;</span><br /> Using highline <span class="br0">&#40;</span>1.6.18<span class="br0">&#41;</span><br /> Using json <span class="br0">&#40;</span>1.7.7<span class="br0">&#41;</span><br /> Using mixlib-log <span class="br0">&#40;</span>1.6.0<span class="br0">&#41;</span><br /> Using mixlib-authentication <span class="br0">&#40;</span>1.3.0<span class="br0">&#41;</span><br /> Using mixlib-cli <span class="br0">&#40;</span>1.3.0<span class="br0">&#41;</span><br /> Using mixlib-config <span class="br0">&#40;</span>1.1.2<span class="br0">&#41;</span><br /> Using mixlib-shellout <span class="br0">&#40;</span>1.1.0<span class="br0">&#41;</span><br /> Using net-ssh <span class="br0">&#40;</span>2.6.7<span class="br0">&#41;</span><br /> Using net-ssh-gateway <span class="br0">&#40;</span>1.2.0<span class="br0">&#41;</span><br /> Using net-ssh-multi <span class="br0">&#40;</span><span class="nu0">1.1</span><span class="br0">&#41;</span><br /> Using ipaddress <span class="br0">&#40;</span>0.8.0<span class="br0">&#41;</span><br /> Using systemu <span class="br0">&#40;</span>2.5.2<span class="br0">&#41;</span><br /> Using yajl-ruby <span class="br0">&#40;</span>1.1.0<span class="br0">&#41;</span><br /> Using ohai <span class="br0">&#40;</span>6.16.0<span class="br0">&#41;</span><br /> Using mime-types <span class="br0">&#40;</span><span class="nu0">1.23</span><span class="br0">&#41;</span><br /> Using rest-client <span class="br0">&#40;</span>1.6.7<span class="br0">&#41;</span><br /> Using chef <span class="br0">&#40;</span>11.4.4<span class="br0">&#41;</span><br /> Using bundler <span class="br0">&#40;</span>1.3.5<span class="br0">&#41;</span><br /> Your bundle is <span class="kw3">complete</span><span class="sy0">!</span><br /> Use <span class="sy0">`</span>bundle show <span class="br0">&#91;</span>gemname<span class="br0">&#93;</span><span class="sy0">`</span> to see where a bundled gem is installed.
  </div>
</div>

Il vous a ajouté un fichier Gemfile.lock qui permet de &laquo;&nbsp;figer&nbsp;&raquo; les versions de Gem à utiliser dans votre projet.

Vous pouvez dès maintenant les ajouter dans Git (je l&rsquo;avais déjà fait, c&rsquo;est pour ça que vous ne trouverez pas ce commit sur mon Github) :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    <span class="kw2">git add</span> Gemfile<span class="sy0">*</span> ; <span class="kw2">git commit</span> <span class="re5">-m</span> <span class="st0">"Add Gemfile(s)"</span>
  </div>
</div>

Nous allons metre à jour le fichier Gemfile :

<div class="codecolorer-container ruby default" style="overflow:auto;white-space:nowrap;">
  <div class="ruby codecolorer">
    <span class="co1"># All you need for manage chef repository</span><br /> source <span class="st0">"https://rubygems.org"</span>
  </div>
</div>

gem &laquo;&nbsp;chef&nbsp;&raquo;  
gem &laquo;&nbsp;foodcritic&nbsp;&raquo;  
gem &laquo;&nbsp;chefspec&nbsp;&raquo;

gem &laquo;&nbsp;guard&nbsp;&raquo;  
gem &laquo;&nbsp;guard-rspec&nbsp;&raquo;

if RUBY_PLATFORM =~ /darwin/i  
gem &lsquo;rb-fsevent&rsquo;, &lsquo;~> 0.9.1&rsquo;  
gem &lsquo;growl&rsquo;  
end

Un petit coup de bundle :

<div class="codecolorer-container bash default" style="overflow:auto;white-space:nowrap;">
  <div class="bash codecolorer">
    Resolving dependencies...<br /> Using builder <span class="br0">&#40;</span>3.2.0<span class="br0">&#41;</span><br /> Using erubis <span class="br0">&#40;</span>2.7.0<span class="br0">&#41;</span><br /> <span class="br0">&#91;</span>...<span class="br0">&#93;</span><br /> Using treetop <span class="br0">&#40;</span>1.4.12<span class="br0">&#41;</span><br /> Using foodcritic <span class="br0">&#40;</span>2.1.0<span class="br0">&#41;</span><br /> Using bundler <span class="br0">&#40;</span>1.3.5<span class="br0">&#41;</span><br /> Your bundle is <span class="kw3">complete</span><span class="sy0">!</span><br /> Use <span class="sy0">`</span>bundle show <span class="br0">&#91;</span>gemname<span class="br0">&#93;</span><span class="sy0">`</span> to see where a bundled gem is installed.
  </div>
</div>

Voilà, voilà. Une fois tout ça en place nous allons dans l&rsquo;article suivant écrire les tests puis nos premiers éléments de recette.

[Vous pouvez passer à la suite ici.][5]

 [1]: http://fr.wikipedia.org/wiki/Test_Driven_Development "Définition Wikipedia du TDD"
 [2]: http://fr.wikipedia.org/wiki/Behavior_Driven_Development "Définition Wikipedia de BDD"
 [3]: http://blog.ledez.net/informatique/chef-2-poste-de-travail/ "Utiliser chef #2 – Installation du poste de travail"
 [4]: http://gembundler.com/ "Le site de Bundler"
 [5]: http://blog.ledez.net/informatique/chef-3-tdd-2/ "Utiliser Chef #3 – TDD ! 2/2"